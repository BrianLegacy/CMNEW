<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0
    Transitional//EN"  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://java.sun.com/jsf/facelets">
    <h:head></h:head>
    <h:body>
        <ui:composition > 
            <style>
                .ui-growl-item-container.ui-state-highlight {
                    border-color: red;
                }
                .formgrid {
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    gap: 20px;
                    margin: 20px;
                }
                .field {
                    display: flex;
                    flex-direction: column;
                    margin-bottom: 15px;
                }
                .field-full {
                    grid-column: span 3;
                }
                .align-center {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                }
                
            </style>
            
            

            <p:growl id="msgs" showDetail="true" life="3000"/>
            <div align="center">
                <p:panel id="maintab" header="AVAILABLE EMAIL USERS::Current Email balance:: #{userScroller.userProfile.maxContacts}" >

                    <h:form id="showusers">
                        <p:commandButton value="Add Email User" style="margin-bottom: 1rem;
                                         padding: 0.5rem 0.5rem 0.5rem 1.3rem;
                                         background-image: url('#{resource['images/addsmsuser.png']}');
                                         background-size: 1.3rem 1.3rem;
                                         background-repeat: no-repeat;
                                         background-position:  0.5rem center;" onclick="PF('createUserDialog').show();" />

                        <div style="display: flex; justify-content: flex-end; margin-bottom: 15px;">
                            <div>

                                <p:commandButton value="Add existing User" onclick="PF('existingUser').show();" />

                                <p:commandButton value =" XLSX"
                                                 title="Export to Excel">
                                    <p:dataExporter type="xlsx" target="table" fileName="Emailusers"/>
                                </p:commandButton>
                                <p:commandButton value =" CSV"
                                                 title="Export to CSV">
                                    <p:dataExporter type="csv" target="table" fileName="Emailusers"/>
                                </p:commandButton>
                            </div>
                        </div>
                        <p:dataTable id="table" var="data" value="#{emailcontroller.emailUsers}"
                                     rows="10"
                                     rowsPerPageTemplate="10, 15, 25"
                                     pageLinks="3"
                                     paginator="true" paginatorPosition="bottom"
                                     paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                     currentPageReportTemplate="{totalRecords} records"
                                     scrollable="true"
                                     resizableColumns="true"
                                       lazy="false">
                            <p:column headerText="Username" sortBy="#{data.username}" filterBy="#{data.username}" filterMatchMode="contains" 
                                      >
                                <h:outputText value="#{data.username}" />
                            </p:column>

                            <p:column headerText="Email Credits">
                                <h:outputText value="#{data.maxContacts}" />
                            </p:column>
                            <p:column headerText="Alert Threshold">
                                <h:outputText value="#{data.alertThreshold}" />
                            </p:column>
                            <p:column headerText="Organization" 
                                      sortBy="#{data.organization}"
                                      filterBy="#{data.organization}" 
                                      filterMatchMode="contains" >
                                <h:outputText value="#{data.organization}" />
                            </p:column>
                            <p:column headerText="Mobile">
                                <h:outputText value="#{data.userMobile}" />
                            </p:column>
                            <p:column headerText="Email" style="width:170px">
                                <h:outputText value="#{data.userEmail}" />
                            </p:column>
                            <p:column headerText="Group"
                                      filterBy="#{data.group}" 
                                      filterMatchMode="contains">
                                <h:outputText value="#{data.group}" />
                            </p:column>

                            <p:column headerText="Action" exportable="false">
                                <!--<h:form id="composition">-->

                                <div style="display: flex; justify-content: space-between;">

                                    <p:commandButton ajax="true" id="editemailcredits" icon="pi pi-credit-card" 
                                                     update="editsmscredits" 
                                                     oncomplete="PF('editsmscredits').show();" 
                                                     title="Click to manage email credit" style=" font-size: 1.4em" >
                                        <p:ajax listener="#{emailcontroller.setCurrentEmailUser(data)}"
                                                update="editsmscredits" 
                                                event="click"/>
                                    </p:commandButton>

                                    <p:commandButton ajax="true" id="editbutton"  style="font-size: 1.5em; font-weight: bold"
                                                     icon="pi pi-user-edit" update="editgroupmodal" 
                                                     oncomplete="PF('editgroupmodal').show();" 
                                                     title="Click to edit" >
                                        <p:ajax listener="#{emailcontroller.setCurrentEmailUser(data)}"
                                                update="editgroupmodal" 
                                                event="click"/>
                                    </p:commandButton>

                                    <p:commandButton ajax="true" id="wrd" 
                                                     icon="pi pi-pencil" update="editgroupmodal" 
                                                     oncomplete="PF('changepass').show();" 
                                                     title="Click to change password"  style="font-size: 1.3em; font-weight: bolder">
                                        <p:ajax listener="#{emailcontroller.setCurrentEmailUser(data)}"
                                                update="changepass" 
                                                event="click"/>
                                    </p:commandButton>


                                    <p:commandButton ajax="true" id="verify" 
                                                     icon="pi pi-check-circle" update="verifyuser" 
                                                     oncomplete="PF('verifyuser').show();" 
                                                     title="Click to verify email user" style="font-size: 1.3em;">
                                        <p:ajax listener="#{emailcontroller.setCurrentEmailUser(data)}"
                                                event="click"/>
                                    </p:commandButton>

                                    <p:commandButton ajax="true" id="deletebutton" 
                                                     update="deletegroupmodal" 
                                                     oncomplete="PF('deletegroupmodal').show();" 
                                                     title="Click to delete user" icon="pi pi-trash" style="font-size: 1.3em;">
                                        <p:ajax listener="#{emailcontroller.setCurrentEmailUser(data)}"
                                                update="deletegroupmodal" 
                                                event="click"/>
                                    </p:commandButton>

                                </div>

                            </p:column>
                        </p:dataTable>
                    </h:form>

                    <p:dialog id="changepass" widgetVar="changepass" header="Change User Password" modal="true" width="600">
                        <h:form id="changePassform">
                            <p:panelGrid columns="2" style="padding: 1rem; border: none !important">
                                <p:outputLabel for="cpusername" value="Username"/>
                                <p:outputLabel  id="cpusername"  value="#{emailcontroller.currentEmailUser.username}"/>

                                <p:outputLabel for="newpass" value="New password"/>
                                <p:inputText id="newpass" type="password" value="#{emailcontroller.newPassword}"/>

                                <p:outputLabel for="confirmpass" value="Confirm Password"/>
                                <p:inputText id="confirmpass" type="password" value="#{emailcontroller.confirmPassword}"/>

                                <p:commandButton value="save" action="#{emailcontroller.changePass()}"
                                                 update=":msgs"
                                                 oncomplete="PF('changepass').hide();"/>
                                <p:commandButton value="cancel" onclick="PF('changepass').hide();"/>
                            </p:panelGrid>
                        </h:form>
                    </p:dialog>


                     <p:dialog id="verifyuser" widgetVar="verifyuser" header="Verify User" modal="true" width="350">
                        <h:form>
                            <p:outputLabel> Are you sure you want to verify #{emailcontroller.currentEmailUser.username}'s email account</p:outputLabel>
                            <div>
                                <p:commandButton value="Proceed" action="#{emailcontroller.verify()}"  style=" margin: 10px"  ajax="false" update=":showusers:table :msgs :maintab"/>
                                <p:commandButton value="Cancel" onclick="PF('verifyuser').hide()"/>
                            </div>
                        </h:form>
                    </p:dialog>

                    <!--edit email-user dialog-->
                    <p:dialog header="Edit Email Credits" widgetVar="editsmscredits" id="editsmscredits" modal="true">
                        <h:form id="editEmailCreditsForm">
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                    <p:outputLabel for="username" value="Username" style="margin-right: 10px; width: 150px;"/>
                                    <p:inputText id="username" value="#{emailcontroller.currentEmailUser.username}" readonly="true"/>
                                </div>
                                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                    <p:outputLabel for="availableCredits" value="Available Email Credits" style="margin-right: 10px; width: 150px;"/>
                                    <p:inputText id="availableCredits" value="#{emailcontroller.currentEmailUser.maxContacts}" readonly="true"/>
                                </div>
                                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                    <p:outputLabel for="action" value="Select Action" style="margin-right: 10px; width: 150px;"/>
                                    <p:selectOneMenu id="action" value="#{emailcontroller.currentEmailUser.creditManageType}" >
                                        <f:selectItem itemLabel="Add Credit" itemValue="add"/>
                                        <f:selectItem itemLabel="Alter Credit" itemValue="update"/>
                                    </p:selectOneMenu>
                                </div>
                                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                    <p:outputLabel for="creditValue" value="Email Credit Value" style="margin-right: 10px; width: 150px;"/>
                                    <p:inputText id="creditValue" value="#{emailcontroller.currentEmailUser.creditsToManage}"/>
                                </div>
                                <!-- Hidden fields -->
                                <h:inputHidden id="secret_username" value="#{emailcontroller.currentEmailUser.username}"/>
                                <h:inputHidden id="secrete_smsCredit" value="#{emailcontroller.currentEmailUser.smsCredits}"/>
                                <!-- Command Button -->
                                <div class="field-full align-center">
                                    <p:commandButton value="Execute"
                                                     action="#{emailcontroller.manageCredit()}"
                                                     update=":showusers:table, :msgs :maintab"
                                                     oncomplete="if (#{facesContext.maximumSeverity==null}) PF('editsmscredits').hide();"/>
                                    <p:commandButton value="Cancel" onclick="PF('editsmscredits').hide();"/>
                                </div>
                            </div>
                        </h:form>
                    </p:dialog>

                    <!--create new emailuser-->
                    <p:dialog header="Create New Email User" widgetVar="createUserDialog" id="createUserDialog" modal="true" width="800">
                        <h:form id="createUserForm">
                            <div class="card">
                                <div class="formgrid">
                                    <div class="field">
                                        <p:outputLabel for="username" value="Username"/>
                                        <p:inputText id="username" value="#{emailcontroller.newEmailUser.username}" 
                                                     required="true" placeholder="" 
                                                     requiredMessage="Enter Username">
                                            <f:validator validatorId="customUsernameValidator"/>
                                            <f:ajax event="blur" render="usernameMessage" />
                                        </p:inputText>
                                        <p:message for="username" id="usernameMessage" />
                                    </div>
                                    <div class="field">
                                        <p:outputLabel for="password" value="Password"/>
                                        <p:inputText id="password" value="#{emailcontroller.newEmailUser.password}" 
                                                     required="true" type ="password" 
                                                     requiredMessage="Enter password" 
                                                     validatorMessage="Enter password">
                                            <f:ajax event="blur" render="passwordMessage" />
                                        </p:inputText>
                                        <p:message for="password" id="passwordMessage" />
                                    </div>
                                    <div class="field">
                                        <p:outputLabel for="smscredits" value="Email Credits"/>
                                        <p:inputText id="smscredits" value="#{emailcontroller.newEmailUser.emailCredits}" 
                                                     required="true" placeholder="" 
                                                     requiredMessage="Enter credits">
                                            <f:validator validatorId="validateEmailCredits"/>
                                            <f:ajax event="blur" render="smsCreditsMessage" />
                                        </p:inputText>
                                        <p:message for="smscredits" id="smsCreditsMessage" />
                                    </div>

                                    <div class="field">
                                        <p:outputLabel for="useremail" value="User Email"/>
                                        <p:inputText id="useremail" value="#{emailcontroller.newEmailUser.userEmail}" 
                                                     required="true" placeholder="" 
                                                     requiredMessage="Enter User Email" 
                                                     validatorMessage="Enter User Email">
                                            <f:ajax event="blur" render="userEmailMessage" />
                                        </p:inputText>
                                        <p:message for="useremail" id="userEmailMessage" />
                                    </div>
                                    <div class="field">
                                        <p:outputLabel for="group" value="Group"/>
                                        <p:selectOneMenu id="group" value="#{emailcontroller.newEmailUser.groupId}" filter="true">
                                            <f:selectItem itemLabel="Select Group" itemValue="" />
                                            <f:selectItems value="#{emailcontroller.listGroups}" var="group" itemLabel="#{group.label}" itemValue="#{group.value}" />
                                        </p:selectOneMenu>
                                    </div>
                                    <div class="field">
                                        <p:outputLabel for="organization" value="Organization"/>
                                        <p:inputText id="organization" value="#{emailcontroller.newEmailUser.organization}" 
                                                     required="true" placeholder="" 
                                                     requiredMessage="Enter organization" 
                                                     validatorMessage="Enter organization">
                                            <f:ajax event="blur" render="organizationMessage" />
                                        </p:inputText>
                                        <p:message for="organization" id="organizationMessage" />
                                    </div>
                                    <div class="field">
                                        <p:outputLabel for="usermobile" value="User Mobile"/>
                                        <p:inputText id="usermobile" value="#{emailcontroller.newEmailUser.userMobile}" 
                                                     required="true" placeholder="" 
                                                     requiredMessage="Enter User Mobile" 
                                                     validatorMessage="Enter User Mobile">
                                            <f:ajax event="blur" render="userMobileMessage" />
                                        </p:inputText>
                                        <p:message for="usermobile" id="userMobileMessage" />
                                    </div>
                                    <div class="field">
                                        <p:outputLabel for="alertthreshold" value="Alert Threshold"/>
                                        <p:inputText id="alertthreshold" value="#{emailcontroller.newEmailUser.alertThreshold}" 
                                                     required="true" placeholder="">
                                            <f:ajax event="blur" render="alertThresholdMessage" />
                                        </p:inputText>
                                        <p:message for="alertthreshold" id="alertThresholdMessage" />
                                    </div>
                                    <div class="field">
                                        <p:outputLabel for="arrears" value="Arrears"/>
                                        <p:inputText id="arrears" value="#{emailcontroller.newEmailUser.arrears}" 
                                                     required="true" placeholder="">
                                            <f:ajax event="blur" render="arrearsMessage" />
                                        </p:inputText>
                                        <p:message for="arrears" id="arrearsMessage" />
                                    </div>
                                    <div class="field-full align-center">
                                        <p:outputLabel for="enableemailalert" value="Enable email alert when credit is over"/>
                                        <p:selectBooleanCheckbox id="enableemailalert" 
                                                                 value="#{emailcontroller.newEmailUser.enableEmailAlertWhenCreditOver}"/>
                                    </div>
                                    <div class="field-full align-center">
                                        <p:commandButton value="Save" icon="fa fa-save" 
                                                         action="#{emailcontroller.addEmailUser()}"
                                                         update=":showusers:table :msgs :maintab "
                                                         oncomplete="PF('createUserDialog').hide()"
                                                         id="savegroupbutton"/>
                                    </div>
                                </div>
                            </div>
                        </h:form>
                    </p:dialog>

                    <!--end create email user dialog-->

                    <p:dialog header="Edit Email User" widgetVar="editgroupmodal" id="editgroupmodal" modal="true" width="800">
                        <h:form id="editUserForm">
                            <div class="card">
                                <div class="formgrid">
                                    <div class="field">
                                        <p:outputLabel for="username" value="Username"/>
                                        <p:inputText id="username" value="#{emailcontroller.currentEmailUser.username}"/>
                                    </div>

                                    <div class="field">
                                        <p:outputLabel for="organization" value="Organization"/>
                                        <p:inputText id="organization" value="#{emailcontroller.currentEmailUser.organization}"/>
                                    </div>

                                    <div class="field">
                                        <p:outputLabel for="mobile" value="Mobile"/>
                                        <p:inputText id="mobile" value="#{emailcontroller.currentEmailUser.userMobile}"/>
                                    </div>
                                    <div class="field">
                                        <p:outputLabel for="groups" value="Group"/>
                                        <p:selectOneMenu id="groups" value="#{emailcontroller.currentEmailUser.groupId}" filter="true">
                                            <f:selectItem itemLabel="#{emailcontroller.currentEmailUser.group}" itemValue="" />
                                            <f:selectItems value="#{emailcontroller.listGroups}" var="group" itemLabel="#{group.label}" itemValue="#{group.value}" />
                                        </p:selectOneMenu>
                                    </div>
                                    <div class="field">
                                        <p:outputLabel for="email" value="Email"/>
                                        <p:inputText id="email" value="#{emailcontroller.currentEmailUser.userEmail}"/>
                                    </div>

                                    <div class="field">
                                        <p:outputLabel for="alertthreshold" value="Alert Threshold"/>
                                        <p:inputText id="alertthreshold" value="#{emailcontroller.currentEmailUser.alertThreshold}"/>
                                    </div>

                                    <div class="field" style="display: #{userScroller.showReseller() ? 'block' : 'none'};">
                                        <p:outputLabel for="subaccount" value="Can Create Sub-Account"/>
                                        <p:selectBooleanCheckbox id="subaccount" value="#{userScroller.currentItem.createAccount}"/>
                                    </div>

                                    <div class="field">
                                        <p:outputLabel for="alert" value="Enable Email Alert"/>
                                        <p:selectBooleanCheckbox id="alert" value="#{emailcontroller.currentEmailUser.enableEmailAlertWhenCreditOver}"/>
                                    </div>

                                    <div class="field" style="display: #{userScroller.showReseller() ? 'block' : 'none'};">
                                        <p:outputLabel for="group" value="Group"/>
                                        <p:selectOneMenu id="group" value="#{userController.alphanumeric}">
                                            <f:selectItem itemLabel="Select Group" itemValue=""/>
                                            <f:selectItems value="#{userController.comboGroups}"/>
                                        </p:selectOneMenu>
                                    </div>
                                </div>

                                <div class="field-full align-center">
                                    <p:commandButton style="margin-right: 10px"
                                                     action="#{emailcontroller.editEmailUser()}"
                                                     update=":showusers:table :msgs"
                                                     oncomplete="PF('editgroupmodal').hide();"
                                                     value="Save"/>
                                    <p:commandButton value="Cancel" onclick="PF('editgroupmodal').hide();"/>
                                </div>
                            </div>
                        </h:form>
                    </p:dialog>

                    <p:dialog header="Add from existing user" widgetVar="existingUser"  id="existingUser"  modal="true" >
                        <h:form>
                            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                                <p:outputLabel for="user" value="user"/>
                                <p:selectOneMenu id="user" value="#{emailcontroller.username}" filter="true">
                                    <f:selectItem itemLabel="Select One existing user" itemValue=""/>
                                    <f:selectItems value="#{emailcontroller.existingUsers}"/>
                                </p:selectOneMenu>

                                <p:commandButton value ="Add"
                                                 action ="#{emailcontroller.addExistingUser()}"
                                                 update =":showusers:table :msgs"
                                                 oncomplete="PF('existingUser').hide();" 
                                                 >
                                </p:commandButton>

                            </div>
                        </h:form>
                    </p:dialog>


                    <p:dialog header="Delete Email User" widgetVar="deletegroupmodal"  id="deletegroupmodal"  modal="true" >
                        <h:form>
                            <h:outputText value="Are you sure you want to delete `#{emailcontroller.currentEmailUser.username}` ?"/>
                            <br/>
                            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                                <p:commandButton value ="Delete"
                                                 action ="#{emailcontroller.deleteUser()}"
                                                 update =":showusers:table :msgs"
                                                 oncomplete="PF('deletegroupmodal').hide();" 
                                                 >
                                </p:commandButton>

                                <p:commandButton value="Cancel" onclick="PF('deletegroupmodal').hide();"></p:commandButton>
                            </div>
                        </h:form>
                    </p:dialog> 
                </p:panel>
            </div>

        </ui:composition>
    </h:body>
</html> 